---
title: 'Remote sensing in rangeland fire ecology: Comparing imagery to measured fire behavior, and burn severity across prescribed burns and wildfires'
subtitle:  'Data and analyses'
author: "DAM"
date: "Last compiled: `r Sys.Date()`"
output:
  html_document:
    theme: united
    highlight: tango
    toc: true
    toc_float: true
---
  
```{r setup, echo=FALSE, message = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning= FALSE,
                      message= FALSE, eval = TRUE)
                      #fig.path = "./, dev = c('png', 'pdf')) 
pacman::p_load(tidyverse, sf, ggpattern, pander, readxl, grid, gridExtra)
pacman::p_load_gh('devanmcg/wesanderson')
```


```{r load_data, eval = TRUE}
# Mapping 
load('../../albersEAC.Rdata')
 rx_sf <- read_sf( '../data/OriginalRxBurnPerims.gpkg', 'RxLocations')
 wf_sf <- read_sf('../data/SeverityComparison.gpkg', 'GreatPlainsModifiedWF')
 ngp <- read_sf('../data/MapStuff.gpkg', 'ngp')
 ngp_counties <- read_sf('../data/MapStuff.gpkg', 'ngp_counties')
 usa <- read_sf('../data/MapStuff.gpkg', 'usa')
 gp <- read_sf('../data/MapStuff.gpkg', 'gp')
 NGP <- read_sf('../data/MapStuff.gpkg', 'NGP_states') # L3 for MT, ND, SD
 NGP_fires <- read_sf('../data/MapStuff.gpkg', 'NGP_fires')
 load('../data/ppt_dat.Rdata')
 

# Data 
  load('../data/BurnIndices.Rdata')
  load('../data/BurnModels.Rdata')
  load('../data/BurnSeverityData.Rdata')
# Aesthetics
  blues <- c(wes_palette('Zissou1')[2], wes_palette('Zissou1')[1])
```

# Overview 

## Objectives 

* Determine the relationship between *in agris* fire behavior measurements and remotely-sensed burn severity
* Compare burn severity across planned (Rx fire) and unplanned (wildfire) events
* Assess utility of fuelbed NDVI as predictor of fire behavior and burn severity

## Hypotheses

1. Positive linear relationship between *in agris* fire behavior and RS burn severity (higher intensity removes more aboveground plant material)
2. No difference in burn severity among wildfires and prescribed fires (Rx fires demonstrate a wide range of burn severity that likely overlaps that of wildfires)
3. Negative relationship between burn severity and NDVI (intensity declines with fine fuel moisture, indicated by high NDVI)

# Maps 

```{r region_map}
ggplot() + theme_void() +
  geom_sf(data = NGP, 
          aes(fill = NA_L3NAME), 
          alpha = 0.6) +
  geom_sf(data = NGP_fires, 
          pch = 1, alpha = 0.5) + 
  geom_sf_label(data = NGP %>%
                 group_by(STATE_NAME) %>%
                 summarize(area = sum(Shape_Area)) , 
               aes(label = state.abb[match(STATE_NAME,state.name)])) + 
  scale_fill_manual('L3 ecoregion', 
                    values = c("#74A089","#E1BD6D")) +
  theme(legend.position = 'inside', 
        legend.position.inside = c(0.3, 0.23))
```

```{r study_map}
 locations <- 
   bind_rows( 
    wf_sf %>% 
      st_transform(albersEAC) %>% 
      st_centroid() %>%
      mutate(type = 'Wildfire',
             L3 = case_when(
               FireCode %in% c('Swather_2021','Hwy31101STWest_2022', 'CB00121_2021', 
                               'CoalSeamWest_2021', '1806HunkpapaCreek_2021') ~
                 'Northwestern Glaciated Plains', 
               TRUE ~ L3), 
      zone = ifelse(L3 == "Northwestern Great Plains", 'Western', 'Eastern'), 
      zone = fct_rev(zone)) %>%
      select(type, zone), 
    rx_sf %>%
      mutate(type = 'Prescribed fire', 
             zone = ifelse(location == "cgrec", 'Eastern', 'Western')) %>%
      select(type, zone) )
  
 states <-  
   ngp %>%
   mutate(Area = st_area(.)) %>%
   group_by(state) %>%
   summarize(Area = sum(Area))  

  ppt_dat$ppt_grd %>%
    st_intersection(ngp, .) %>%
    filter(st_geometry_type(., by_geometry = TRUE) %in% c('MULTIPOLYGON', 'POLYGON'))  %>%
    mutate(anomaly = case_when(
      L3 == "Northwestern Glaciated Plains" ~ ppt - 447,  
      L3 == "Northwestern Great Plains" ~ ppt - 431 )) %>%
    ggplot() + theme_void() +
    geom_sf(aes(fill = anomaly), color = 'NA') +
    geom_sf_pattern(data =  ppt_dat$anom_map %>% filter(anom_cat == 'beyond'), 
                    aes(pattern = anom_cat), 
                    pattern_color = NA,
                    pattern_fill = "grey80",
                    pattern_angle = 45,
                    pattern_alpha = 0.5,
                    pattern_density = 0.5,
                    pattern_spacing = 0.025,
                    pattern_key_scale_factor = 1,, 
                    show.legend = F) +
    geom_sf(data = ngp_counties, fill = NA, color = 'grey70') + 
    geom_sf(data = states, fill = NA, color = 'black') + 
    geom_sf_text(data = states %>%
                   st_centroid(), 
                 aes(label = state),
                 fontface = 'bold',
                  color = 'black') + 
    geom_sf_label(data = locations %>% filter(type != 'Wildfire'), 
            aes(color = zone),
            label = expression(R[X]), 
            label.padding = unit(0.1, "lines"),
            label.r = unit(0.5, "lines"),
            label.size = 0.15,
            size = 5) +
    geom_sf(data = locations %>% filter(type == 'Wildfire'), 
            aes(shape = zone, color = zone), 
             stroke = 2, size = 3) +
    # geom_sf(data = locations, aes(shape = type, color = type), 
    #         fill = 'lightgreen', 
    #         stroke = 2, size = 3) +
    scale_fill_gradient2("Precipitation\nanomaly (mm)", 
                         low = wes_palette("Zissou1")[4],
                         mid = 'white',
                         high = wes_palette("Zissou1")[1], 
                         na.value = "grey70") +
    scale_pattern_manual(values = c(beyond = "circle", within = "none")) + 
    scale_shape_manual('Zone', values = c(4,3)) + 
    scale_color_manual('Fire type', values = c('darkgreen', 'darkred'), guide = 'none')
```  

# Fire behavior and burn severity

## Burn severity as response

```{r dNBR_v_FB, fig.width = 8, fig.height = 3, fig.cap = " "}
  BurnIndices %>%
  filter(dNBR > 0) %>%
    mutate(ros = ifelse(ros >= 13, NA, ros)) %>%
    pivot_longer(names_to = 'behavior', 
                 values_to = 'value', 
                 cols = c(MaxC:ros)) %>%
    mutate(behavior = fct_relevel(behavior, c('MaxC', 'SoilMaxC', 'ros')), 
           Behavior = recode(behavior, 
                        ros = 'Spread rate (m/min)', 
                        SoilMaxC = 'Soil surface temp (°C)',
                        MaxC = 'Flame temp (°C)') )   %>%
 
    ggplot(aes(x = value, y = dNBR)) + theme_bw(16) +
    geom_smooth(data = . %>%
                  filter(behavior != 'SoilMaxC'), 
                method = 'lm', 
                color = blues[1],
                fill = blues[2] ) +
    geom_smooth(data = . %>%
                  filter(behavior == 'SoilMaxC'), 
                method = 'lm', 
                lty = 2, se = F, 
                color = blues[1]) +
    geom_point(pch = 21, size =2, stroke = 1,
               color = 'grey20', fill=blues[1]  ) +
  labs(x = '', y = 'Burn severity (ΔNBR)') + 
    facet_wrap(~Behavior, scales = 'free_x') +
  theme(strip.text = element_text(face = 'bold'), 
        plot.margin=margin(c(3,10,-10,3), 'em'))
```
  
```{r }
      bind_rows(
      BurnModels$Sev_v_MaxC[2,c(6,8)] %>% 
        tibble() %>%
        add_column(Predictor = 'Flame temperature', .before = 1), 
      BurnModels$Sev_v_SoilMaxC[2,c(6,8)] %>% 
        tibble() %>%
        add_column(Predictor = 'Soil surface temperature', .before = 1), 
      BurnModels$Sev_v_ROS[2,c(6,8)] %>% 
        tibble() %>%
        add_column(Predictor = 'Rate of spread', .before = 1) ) %>%
        mutate(Chisq = signif(Chisq, 3), 
               Chisq = round(Chisq, 1)) %>%
        arrange(desc(Chisq)) %>%
      rename('χ$^2$' = Chisq, 
            P = `Pr(>Chisq)` ) %>%
      mutate(P = case_when(
              between(P,0.0009, 0.01) ~ '< 0.01',
              P <= 0.0009 ~ '< 0.001', 
              P >= 0.05 ~ '> 0.05', 
              TRUE ~ as.character(round(P, 2) ) ))  %>%
        pander::pander( )
```

## Fuelbed greenness as the predictor 

```{r FB_v_ndvi, fig.cap = " "}
  BurnIndices %>%
   filter(dNBR > 0) %>%
    mutate(ros = ifelse(ros >= 13, NA, ros)) %>%
    pivot_longer(names_to = 'response', 
                 values_to = 'value', 
                 cols = c(MaxC:dNBR)) %>%
    mutate(response = fct_relevel(response, c('MaxC', 'SoilMaxC', 'ros', 'dNBR')), 
           Response = recode(response, 
                        ros = 'Spread rate (m/min)', 
                        SoilMaxC = 'Soil surface temp (°C)',
                        MaxC = 'Flame temp (°C)', 
                        dNBR = 'Burn severity (ΔNBR)') )   %>%
 
    ggplot(aes(x = ndvi, y = value)) + theme_bw(16) +
    geom_smooth(data = . %>%
                  filter(response != 'SoilMaxC'), 
                method = 'lm', 
                color = blues[1],
                fill = blues[2] ) +
    geom_smooth(data = . %>%
                  filter(response == 'SoilMaxC'), 
                method = 'lm', 
                lty = 2, se = F, 
                color = blues[1]) +
    geom_point(pch = 21, size =2, stroke = 1,
               color = 'grey20', fill=blues[1]  ) +
  labs(x = 'Fuelbed greenness (NDVI)', y = '' ) + 
    facet_wrap(~Response, scales = 'free_y') +
  theme(strip.text = element_text(face = 'bold'), 
        plot.margin=margin(c(2,2,2,-10), 'mm'))
```

```{r}
      bind_rows(
        BurnModels$MaxC_v_NDVI[2,c(6,8)] %>% 
          tibble() %>%
          add_column(Response = 'Flame temperature', .before = 1), 
        BurnModels$SoilMaxC_v_NDVI[2,c(6,8)] %>% 
          tibble() %>%
          add_column(Response = 'Soil surface temperature', .before = 1), 
        BurnModels$ROS_v_NDVI[2,c(6,8)] %>% 
          tibble() %>%
          add_column(Response = 'Rate of spread', .before = 1), 
        BurnModels$dNBR_v_NDVI[2,c(6,8)] %>% 
          tibble() %>%
          add_column(Response = 'Burn severity', .before = 1)  ) %>%
        mutate(Chisq = signif(Chisq, 3), 
               Chisq = round(Chisq, 1)) %>%
        arrange(desc(Chisq)) %>%
        rename('χ$^2$' = Chisq, 
               P = `Pr(>Chisq)` ) %>%
        mutate(P = case_when(
          between(P,0.0009, 0.01) ~ '< 0.01',
          P <= 0.0009 ~ '< 0.001', 
          P >= 0.05 ~ '> 0.05', 
          TRUE ~ as.character(round(P, 2) ) ))  %>%
        pander::pander( )
```

# Wildfires vs. Rx burns

```{r WF_v_Rx, fig.width = 8, fig.height = 4, fig.cap = " "}
    BurnSeverityData  %>% 
      mutate(zone = ifelse(L3 == "Northwestern Great Plains", 
                           'Western zone', 'Eastern zone'), 
             zone = fct_rev(zone), 
             type = fct_relevel(type, c("Wildfire",'Rx' )), 
             type = recode(type, 'Rx'= "Prescribed\nburn")) %>%
      ggplot(aes(x= type, y = dNBR_Mean)) + theme_bw(16) +
       geom_boxplot(varwidth = TRUE, 
                    fill = 'lightblue', 
                    staplewidth = 0.25) +
       geom_point(data = . %>%
                   group_by(type, zone) %>%
                   summarize(Mean = mean(dNBR_Mean)), 
                 aes(y = Mean), 
                 pch = 24, size = 4, 
                 color = 'white', fill = 'darkblue') + 
      labs(x = 'Fire type', 
           y = 'Burn severity (ΔNBR)') +           
      facet_wrap(~zone, scales = 'free_x') +
      theme(panel.grid.major.x = element_blank(), 
            axis.text.x = element_text(color = 'black'))
```

```{r wf_rx_int}
  emmeans::joint_tests(BurnModels$type_comp) %>%
    tibble() %>%
    rename(`F` = F.ratio, P = p.value) %>%
    mutate(`F` = signif(F, 2),
           P = case_when(
             between(P,0.0009, 0.01) ~ '< 0.01',
             P <= 0.0009 ~ '< 0.001', 
             P >= 0.05 ~ '> 0.05', 
             TRUE ~ as.character(round(P, 2) ) ) )  %>%
  pander::pander('emmeans test indicates significant type x zone interaction.')
```

```{r wf_rx_comp}
  emmeans::joint_tests(BurnModels$type_comp, by = 'zone')  %>%
    tibble() %>%
    rename(`F` = F.ratio, P = p.value) %>%
    mutate(`F` = signif(F, 2),
           P = case_when(
             between(P,0.0009, 0.01) ~ '< 0.01',
             P <= 0.0009 ~ '< 0.001', 
             P >= 0.05 ~ '> 0.05', 
             TRUE ~ as.character(round(P, 2) ) ) )  %>%
  pander::pander('emmeans test on contrasts within the interactive linear model indicates significant difference between burn severity in wildfires vs prescribed burns in the eastern zone, but not in the western zone.')
```